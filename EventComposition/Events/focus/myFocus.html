<script src="../../1b_EventLoop/demo/toggleTick.js"></script>
<!--<input type="text" tabindex="1">-->
<!--test 1-->

<body tabindex="-1">
<web-comp></web-comp>
<HR>
<web-comp></web-comp>
</body>

<script>
  //bouncing dblclick
  (function () {

    let lastLightTarget;
    let lastShadowTarget;


    let targets = [];


    function bounceDispatchEvent(evt, details) {
      for (let target of targets)
        target.dispatchEvent(new CustomEvent(evt, {composed: false, bubbles: details}));
    }

    function bouncingKeydownController(e) {

      // 1 - click to the body to set a focus start point. We can not use Tab for focus without it.
      // 2 - start point has been set (body) so press Tab button will fire on <body> element and only then switch to the <web-comp> and inner <div>. So this means that it is necessary to find another way to set initial focus without click.


      if (e.target instanceof HTMLBodyElement)
        return;

      if (!lastLightTarget)
        lastLightTarget = e.target;

      if (!(lastLightTarget.hasAttribute("my-focus")))
        lastLightTarget.setAttribute("my-focus", "");


      targets.unshift(e.target)


    }

    function bouncingClickController(e) {
      //shadowDOM handler
      if (!lastShadowTarget && !(e.target instanceof HTMLBodyElement)) {
        lastShadowTarget = e.target;
        if (!(lastShadowTarget.hasAttribute("my-focus")))
          lastShadowTarget.setAttribute("my-focus", "");
        toggleTick(bounceDispatchEvent.bind(null, "my-focus", false));
        toggleTick(bounceDispatchEvent.bind(null, "my-focusin", true));
        toggleTick(function () {
          targets = [];
        })
        return targets.unshift(e.target);
      }

      //lightDOM handler
      if (lastShadowTarget !== lastLightTarget && !lastLightTarget && !(e.target instanceof HTMLBodyElement)) {

        lastLightTarget = e.target;
        // ctx, evt, bubbles
        toggleTick(bounceDispatchEvent.bind(null, "my-focus", false));
        toggleTick(bounceDispatchEvent.bind(null, "my-focusin", true));
        return targets.unshift(e.target);
      }

      if (lastLightTarget && lastShadowTarget && lastShadowTarget !== e.target && lastLightTarget !== e.target) {
        toggleTick(bounceDispatchEvent.bind(null, "my-focusout", true));
        targets.unshift(lastLightTarget, lastShadowTarget);
        lastShadowTarget.removeAttribute("my-focus");
        lastLightTarget = lastShadowTarget = undefined;
        toggleTick(function () {
          targets = [];
        })
      }
    }

    window.addBouncingMousedownController = function (domContextRoot) {
      // domContextRoot.addEventListener("mousedown", bouncingClickController);
    };

    window.addBouncingKeydownController = function (domContextRoot) {
      document.body.focus();
      domContextRoot.addEventListener("keydown", bouncingKeydownController, true);
    };
  })();

  addBouncingMousedownController(window);

  addBouncingKeydownController(document.body);


  window.addEventListener("my-focus", e => console.warn(e.type, e.target), true);
  window.addEventListener("my-focusin", e => console.warn(e.type, e.target), true);
  window.addEventListener("my-focusout", e => console.warn(e.type, e.target), true);

  // window.addEventListener("focus", e => console.log(e.type, e.target), true);
  window.addEventListener("focusin", e => console.log(e.type, e.target), true);
  window.addEventListener("focusout", e => console.log(e.type, e.target), true);
  // window.addEventListener("blur", e => console.log(e.type, e.target), true);

  // window.addEventListener("click", e => console.log(e.type, e.target), true);


  class WebComp extends HTMLElement {
    constructor() {
      super();
      const shadow = this.attachShadow({mode: "closed"});
      addBouncingMousedownController(shadow);
      addBouncingKeydownController(shadow);
      shadow.innerHTML = `
        <style>
        div{
            height: 30px;
            width: 100px;
            border: 1px solid gray;
         }
         div[my-focus]{
           box-shadow: 0 0 0 3px rgba(239,159,28,0.97);
         }
        </style>
        <div tabindex="1"></div>


`;

      shadow.addEventListener("my-focus", e => console.warn("shadow|   ", e.type, e.target), true);
      shadow.addEventListener("my-focusin", e => console.warn("shadow|   ", e.type, e.target), true);
      shadow.addEventListener("my-focusout", e => console.warn("shadow|   ", e.type, e.target), true);

      shadow.addEventListener("focusin", e => console.log("shadow|   ", e.type, e.target), true);
      // shadow.addEventListener("focus", e => console.log("shadow|   ", e.type, e.target), true);
      shadow.addEventListener("focusout", e => console.log("shadow|   ", e.type, e.target), true);
      // shadow.addEventListener("blur", e => console.warn("shadow|   ", e.type, e.target), true);
      // shadow.addEventListener("click", e => console.warn("shadow|   ", e.type, e.target), true);
    }


  }

  customElements.define("web-comp", WebComp);

</script>


<!--focus does *NOT* bubble when focusin does-->

<!--blur does *NOT* bubble when focusout does-->


<!--focusin-->
<!--focus-->
<!--blur-->
<!--focusout-->
