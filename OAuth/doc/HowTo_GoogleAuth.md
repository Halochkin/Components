# HowTo: Google Authorization with Cloudflare workers

In order to add Google social login to a web application it is necessary:

### Google+ API

1. Go to [Google APIs](https://console.developers.google.com/) and login. 
2. Create a new document.
3. Go to the **Dashboard** tab.
4. Press the button **+ENABLE APIS AND SERVICES**.
5. In the search box, type "**Google + API**".
6. Open the API and press the **Manage** button. 
7. In the resulting API menu, go to the **Auth consent screen** tab.
8. Select **Internal** and click **Create**.
9. Fill in the required fields.
10. Go back to the **Credentials**" tab.
11 Click the **Create credentials** button, choose **Create OAuth client ID** from the list.
12. Select **Web application** as **Application type**. 
    1. Add a link to your application as a "Authorized JavaScript origins" value (for example `https://maxworker.maksgalochkin2.workers.dev`).
    2. As the value "**Authorized redirect URIs**" you need to specify the link that will be opened after successful authentication (for example `https://maxworker.maksgalochkin2.workers.dev/callback`).
    3. Press the **Save** button. 
13. API will generate **Client ID** and **Client secret**.

### Cloudflare worker

1. Open [Cloudflare dashboard] (https://dash.cloudflare.com/) and go to the **"Workers"** tab using the menu on the right side of the page.
2. Create a new worker.
3. Go to the **Settings** tab.
4. Define global variables 
   * `GOOGLE_CLIENTID=<CLIENT_ID>.apps.googleusercontent.com` - Your _client ID_. 
   * `GOOGLE_CLIENTSECRET=<CLIENT_SECRET>` - Your _client Secret_.
   * `GOOGLE_CODE_LINK=https://oauth2.googleapis.com/token` - Google Auth access token.
   	
     To access the endpoint from your code you need to provide an access token. The access token provided in response to the above call to the token endpoint expires pretty quickly, usually in an hour, so it is not sufficient to just store that and reuse it. The response is JSON that contains an access token like this:
     ```json
       {
         "access_token": "1/fFAGRNJru1FTz70BzhT3Zg",
         "expires_in": 3920,
         "scope": "https://www.googleapis.com/auth/bigquery",
         "token_type": "Bearer"
       }
     ```
   * `GOOGLE_REDIRECT_1=https://accounts.google.com/o/oauth2/v2/auth` - to obtain user authorization. This endpoint handles active session lookup, authenticates the user, and obtains user consent.
   * `GOOGLE_REDIRECT_2=https://<auth-go-gi.2js-no>.workers.dev/callback` - redirect url after successful authentication. Must retaliate against the name of the worker.

5. Inside `handleRequest()` put the code
  ```javascript
  async function handleRequest(request) {
    const url = new URL(request.url);                                                   //[2]
    const [empty, action] = url.pathname.split('/');                                    //[3]
    if (action === "login") {                                                           //[4]
      let redirect = GOOGLE_REDIRECT_1 + `?state=${encodeURIComponent(makeRandomString(12))}&client_id=${encodeURIComponent(GOOGLE_CLIENT_ID)}&nonce=${encodeURIComponent(makeRandomString(12))}&response_type=${encodeURIComponent("code")}&redirect_uri=${encodeURIComponent(GOOGLE_REDIRECT_2)}&scope=${encodeURIComponent("openid email")}&`; //[5]
      return Response.redirect(redirect);                                               //[6]
    }
    if (action === "callback") {                                                        //[7]
      const code = url.searchParams.get('code');                                        //[8]
      let userInfo = await googleProcessTokenPackage(code);                             //[9]
      return new Response(JSON.stringify(userInfo));                                    //[10]
    }
    const mainpage = `<a href='/login'>login google</a>`;
    return new Response(mainpage, { headers: { 'Content-Type': 'text/html' } });        //[1]
  }
  ```

 1. Render _Login_ button if user is not logged in.
 2. Getting the URL values. 
 3. Defining a command that defines the following behavior of an application. The first argument is ignored, only `action` is used.
 4. Clicking on the button will add "/login" to the url.
 5. After clicking on the button for authentication (Login), the user must be redirected to the login form provided by the API. For successful authentication the browser must make a request by passing some parameters using the URL:
   
      * `state`  should include the value of the anti-forgery unique session token, as well as any other information needed to recover the context when the user returns to your application, e.g., the starting URL.  
      * `client_id`  credential generated client ID value.        
      * `nonce` random value generated by your app that enables replay protection when present.
      * `responce_uri` should be the HTTP endpoint on your server that will receive the response from Google. The value must exactly match one of the authorized redirect URIs for the OAuth 2.0 client, which you configured in the API Console Credentials page.
      * `scope` basic request should be "openid email".
 
 6. User redirection to login page.
 7. After successful authentication, the user will be redirected back to the web application. The URL will be redirected by the "/callback" parameter.
 8. The response includes a code parameter, a one-time authorization code that your server can exchange for an access token and ID token.
 9. Your server makes this exchange by sending an HTTPS POST request. The POST request is sent to the token endpoint, which you should retrieve from the Discovery document using the token_endpoint metadata value.
 
 ## Process Access Token
  
```javascript
    async function googleProcessTokenPackage(code) {
      const bodyString = `code=${encodeURIComponent(code)}&client_id=${encodeURIComponent(GOOGLE_CLIENT_ID)}&client_secret=${encodeURIComponent(GOOGLE_CLIENT_SECRET)}&redirect_uri=${encodeURIComponent(GOOGLE_REDIRECT_2)}&grant_type=authorization_code`;                                                        //[1]
      const tokenPackage = await fetchAccessToken(bodyString);                //[2]
      const jwt = await tokenPackage.json();                                  //[3]
      const [header, payloadB64url, signature] = jwt.id_token.split('.');     //[4]
      const payloadText = atob(fromBase64url(payloadB64url));                 //[5]
      const payload = JSON.parse(payloadText);                                //[6]
      return JSON.stringify({                                                 //[7]
          id: payload.sub,
          email: payload.email,
          fullname: (payload.given_name + payload.family_name),
          provider: payload.iss
      });
    }
```

   1. POST request is used to get JWT. The request must include the following parameters in the POST body:
       * `code` the authorization code that is returned from the initial request.
       *` client_id`	the **client ID** that you obtain from the API Console Credentials page.
       * `client_secret`	the **client secret** that you obtain from the API Console Credentials page.
       * `redirect_uri` an authorized **redirect URI** for the given client_id specified in the API Console Credentials page.
       * `grant_type` this field must contain a  string value of "authorization_code".
   2. Executing a request. 
       ```javascript
        async function fetchAccessToken(data) {
          return await fetch(GOOGLE_CODE_LINK, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: data
          });
        }
       ```
   3. The `json()` method of the Body mixin takes a response and reads it to completion. The result of execution is JWT.
   4. Getting a header, payload u signature with JWT.
   5. Decoding a string from base64url.
       ```javascript
        function fromBase64url(base64urlStr) {
          base64urlStr = base64urlStr.replace(/-/g, '+').replace(/_/g, '/');
          if (base64urlStr.length % 4 === 2)
            return base64urlStr + '==';
          if (base64urlStr.length % 4 === 3)
            return base64urlStr + '=';
          return base64urlStr;
        }
       ```
   6. Conversion into object.
 10. Response JWT payload.
 
 ### Example
 Full example here
 ```javascript
 addEventListener("fetch", event => {
   event.respondWith(handleRequest(event.request))
 })
 
 function makeRandomString(length) {
   const iv = crypto.getRandomValues(new Uint8Array(length));
   return Array.from(iv).map(b => ('00' + b.toString(16)).slice(-2)).join('');
 }
 
 function fromBase64url(base64urlStr) {
   base64urlStr = base64urlStr.replace(/-/g, '+').replace(/_/g, '/');
   if (base64urlStr.length % 4 === 2)
     return base64urlStr + '==';
   if (base64urlStr.length % 4 === 3)
     return base64urlStr + '=';
   return base64urlStr;
 }
 
 async function fetchAccessToken(data) {
   return await fetch(GOOGLE_CODE_LINK, {
     method: 'POST',
     headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
     body: data
   });
 }
 
async function googleProcessTokenPackage(code) {
    const bodyString = `code=${encodeURIComponent(code)}&client_id=${encodeURIComponent(GOOGLE_CLIENT_ID)}&client_secret=${encodeURIComponent(GOOGLE_CLIENT_SECRET)}&redirect_uri=${encodeURIComponent(GOOGLE_REDIRECT_2)}&grant_type=authorization_code`
    const tokenPackage = await fetchAccessToken(bodyString);
    const jwt = await tokenPackage.json();
    const [header, payloadB64url, signature] = jwt.id_token.split('.');
    const payloadText = atob(fromBase64url(payloadB64url));
    const payload = JSON.parse(payloadText);
    return JSON.stringify({
        id: payload.sub,
        email: payload.email,
        fullname: (payload.given_name + payload.family_name),
        provider: payload.iss
    });
}
 
 async function handleRequest(request) {
   const url = new URL(request.url);
   const [empty, action] = url.pathname.split('/');
   if (action === "login") {
     let redirect = GOOGLE_REDIRECT_1 + `?state=${encodeURIComponent(makeRandomString(12))}&client_id=${encodeURIComponent(GOOGLE_CLIENT_ID)}&nonce=${encodeURIComponent(makeRandomString(24))}&response_type=${encodeURIComponent("code")}&redirect_uri=${encodeURIComponent(GOOGLE_REDIRECT_2)}&scope=${encodeURIComponent("openid email profile")}&`;
     return Response.redirect(redirect);
   }
   if (action === "callback") {
     const code = url.searchParams.get('code');
     let userInfo = await googleProcessTokenPackage(code);
     return new Response(JSON.stringify(userInfo));
   }
   const mainpage = `<a href='/login'>login google</a>`;
   return new Response(mainpage, { headers: { 'Content-Type': 'text/html' } });
 }
 ```
 ### Reference
 
 * [OpenID Connect](https://developers.google.com/identity/protocols/oauth2/openid-connect)
 * [MDN: .json()](https://developer.mozilla.org/en-US/docs/Web/API/Body/json)
 * [Base64](https://en.wikipedia.org/wiki/Base64)
 * [Google APIs](https://console.developers.google.com/)
 * [Live demo](https://maxworker.maksgalochkin2.workers.dev/)