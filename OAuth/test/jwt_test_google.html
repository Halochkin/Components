<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script type="module">
  const privateKey = {
    p: "5bxZBZejvyAK5_vtFMDI2vqmf2zBitAM-Y1tfpDZDIM5Q7jWSlFnhibcfkfK7fg_P4DC87gSkZtYRE5X5JttrG58CNsm8Vvj6DxLBhC_zbtxizhtlhbsV2euTxibeSSG45CjFWqlqXJqbPzhbQBxvwEL1gVu4_-AMU55gTcaHj0",
    kty: "RSA",
    q: "1ENQWNGAf3xBQM2UhUKsy7mHKYFiy3_dWS5JelId1hTdwm9g5sWMP8qsZNdtpfbG0nU7inpAO7vvt3CsAe7bgJR9io511gA32mhtOiswBQdoBDSYd_gJAJHWyp-_5WQP38XaJluuf0gLfxfFugFBs_MEwcByX5dlexMoFLUCSzE",
    d: "NSbh_h5YPtVy2EvVn2J2fZ-Mdx0fbSyBdavnV_2tQKjpV0BIC0K5IaRG7RxpcF5WzTp3RGr2b7qiIF2pm6tXe4dLgkvcOApX9ppaA2ESze8WEPG3BBcXlylU_FYPOZSQ9yTNpzmRxrLc0grJJvjvmBSrjqUtLCvJE15GWW5lhDJPXtadlBgxa7xkeQklddTmbZKhXnjEM4WhCQzUakAKMmK-iLOf2MKdV1Ht5Q6qTuEuxr8Eh6E2yMjnTWU11FIv0vcTtIHXUuHIoxYQsdtUrRc4uvY5Hfn1cjSJ7j8pY9666ac-BBn3bB_GvtXJqc9h0pWhTlNz9i_Xm6vj6JwswQ",
    e: "AQAB",
    use: "sig",
    kid: "8zaYXypVQPODbgom3580DpqYr8MPR5YPd-gcdfRdMzo",
    qi: "GqS1-jQkNIP1NWfYipa_tNpIyoJxqrI15adfSDsuBNUdOc-nTNBXEJZcPLL8xaAdqp7BENgORbsRFXQUFWg4DM_Gvs-6so5LNjI0Fr2ITnaSCYo9T5B9bMFYmLMZ72xfuj80sVl-OD5_5EWGWh-J4SZvqe8fo9bDR6XWvRUIZp8",
    dp: "aLUVpfTdTwkdr2olPmY3pYbESCObetckcsFA_ISsSIWune0qziiYFI61xGCYXyncOedH86kb3X1-F3PVn34v2H1qzuaDs1H8aCbC0vrjULN0Js4LNHMyOQwqaCaBBg_d4u5TRjmbU8WwOAhx_ipLrZCegmdriUM0fESWIIyqvMk",
    alg: "RS256",
    dq: "X3EVA5rQCIK6ZIULrw_X2pLFb6g53_7SbHMfntylhclEHVUvYRSah2R-N6mWJ_XaWG9WImHt1-4dT4JeFVBtaldaS57a5Sqb8pzZ4DnjEZ_O6XUsyWTBx3vL9Lf39REVAi1Ydb7rq1eds7vgsE44WM2A6g26X7kXbEukzgrFyUE",
    n: "vnxiHn6cuLLf-w3Js200XxwgESgy4Gc81AUqdSFLBoMH4juZEqS3yMBpEWtk5t5gcnlEM5qE42o8i7UMhQ9YVPwjBRKj0KnHtY7Br8XZxM-FeyVyYhtLKg1NFoLUItOd5A4Cmq2hOvyel_CW_XB9cgaTEGcyvL-GJAY9Vu4qHgvT6bYAcfxaxos951U0JHJAyJqOspBkF1tffvFwSQmfQDQK-p99-kZTqypa12LKPlXDAWaCbu-DTNVjfz4ufRIs_FobwdPuuJ2Nbm1ou3CxEkdhSaXBvRRF_P3Q3cN5kOuGJ0z5aQLVB45Vq3jH1fDQyc7hRGZQj72s4Oc5kFWorQ"
  };

  const publicKey = {
    kty: "RSA",
    e: "AQAB",
    use: "sig",
    kid: "8zaYXypVQPODbgom3580DpqYr8MPR5YPd-gcdfRdMzo",
    alg: "RS256",
    n: "vnxiHn6cuLLf-w3Js200XxwgESgy4Gc81AUqdSFLBoMH4juZEqS3yMBpEWtk5t5gcnlEM5qE42o8i7UMhQ9YVPwjBRKj0KnHtY7Br8XZxM-FeyVyYhtLKg1NFoLUItOd5A4Cmq2hOvyel_CW_XB9cgaTEGcyvL-GJAY9Vu4qHgvT6bYAcfxaxos951U0JHJAyJqOspBkF1tffvFwSQmfQDQK-p99-kZTqypa12LKPlXDAWaCbu-DTNVjfz4ufRIs_FobwdPuuJ2Nbm1ou3CxEkdhSaXBvRRF_P3Q3cN5kOuGJ0z5aQLVB45Vq3jH1fDQyc7hRGZQj72s4Oc5kFWorQ"
  }

  const rawJWTobj = {
    header: {
      typ: "JWT",
      alg: publicKey.alg,
      kid: publicKey.kid,
    },
    payload: {
      iss: "accounts.google.com",
      azp: "595564072050-5t4i14ge3g0b7knrhn8an9pujha53m6q.apps.googleusercontent.com",
      aud: "595564072050-5t4i14ge3g0b7knrhn8an9pujha53m6q.apps.googleusercontent.com",
      sub: "109171373826051582598",
      email: "intertext.no@gmail.com",
      email_verified: true,
      at_hash: "jamKUOY4mA2W2s0_AKvErA",
      name: "intertext no",
      picture: "https://lh6.googleusercontent.com/-lAKCSPiA0vc/AAAAAAAAAAI/AAAAAAAAAAA/AMZuucmJhlFF4pFJOWQzJrthzwGiMXopag/s96-c/photo.jpg",
      given_name: "intertext",
      family_name: "no",
      locale: "no",
      iat: 1602759736,
      exp: 1602763336,
      jti: "3328672f071cdf5fa40257fe8e51597d513fd4c3"
    }
  };

  function Uint8ToBase64url(one) {
    const two = String.fromCharCode.apply(null, new Uint16Array(one));
    const three = btoa(two);
    return three.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+/g, '');
  }

  function base64urlToUint8Array(four) {
    let three = four.replace(/-/g, '+').replace(/_/g, '/');
    const pad = three.length % 4;
    if (pad === 2)
      three += '==';
    else if (pad === 3)
      three += '=';
    const two = atob(three);
    const one = new Uint8Array(two.length);
    for (let i = 0; i < two.length; i++)
      one[i] = two.charCodeAt(i);
    return one;
  }

  function toBase64url(obj) {
    return btoa(JSON.stringify(obj)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
  }

  function base64urlToString(base64url) {
    let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
    const pad = base64.length % 4;
    if (pad === 2)
      base64 += '==';
    else if (pad === 3)
      base64 += '=';
    return atob(base64);
  }

  async function signJwt(rawJWTobj, privKey) {
    const base64urlHeader = toBase64url(rawJWTobj.header);
    const base64urlPayload = toBase64url(rawJWTobj.payload);
    const data = base64urlHeader + '.' + base64urlPayload;

    const signature = await crypto.subtle.sign({
      name: 'RSASSA-PKCS1-v1_5',
      hash: 'sha-256'
    }, privKey, new TextEncoder().encode(data));
    return data + '.' + Uint8ToBase64url(new Uint8Array(signature));
  }

  async function verifyAndExtract(jwt, pubKeys) {
    const [h64, p64, s64] = jwt.split('.');
    const header = JSON.parse(base64urlToString(h64));

    const verify = await crypto.subtle.verify({
      name: 'RSASSA-PKCS1-v1_5',
      hash: 'sha-256'
    }, pubKeys[header.kid], base64urlToUint8Array(s64), new TextEncoder().encode(h64 + "." + p64));
    if (!verify)
      throw 'hackkkkk!';
    return {header, payload: JSON.parse(base64urlToString(p64))};
  }

  (async function () {

    const privKey = await crypto.subtle.importKey('jwk', privateKey, {
      name: 'RSASSA-PKCS1-v1_5',
      hash: 'sha-256'
    }, true, ['sign']);
    console.log(rawJWTobj);
    const jwt = await signJwt(rawJWTobj, privKey);
    console.log(jwt);
    const keys = {};
    keys[publicKey.kid] = await crypto.subtle.importKey('jwk', publicKey, {
      name: 'RSASSA-PKCS1-v1_5',
      hash: 'sha-256'
    }, false, ['verify']);
    const verify = await verifyAndExtract(jwt, keys);
    console.log(verify);
  })();
</script>
</body>
</html>