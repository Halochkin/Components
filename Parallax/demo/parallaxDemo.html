<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>parallaxDemo</title>
    <style>
        parent-parallax {
            display: block;
            height: 1500px;
            width: 1000px;
            background-image: url("https://i.pinimg.com/originals/d8/10/33/d810337427b40d0c17cf56b90d8490a1.jpg");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-attachment: fixed;
        }

        child-parallax {
            /*position: fixed;*/
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        #car {
            height: 10vh;
            width: 10vh;
            background-image: url("https://i.dlpng.com/static/png/169943_thumb.png");
            top: 25vh;
            left: 45vw;
            z-index: 2;
        }

        #dust {
            background-image: url("https://img.pngio.com/dust-png-27png-dust-png-831_508.png");
            height: 30vh;
            width: 50vw;
            top: 10vh;
            left: 28vw;
            z-index: 1;
        }

        #sun {
            background-image: url("https://www.stickpng.com/assets/images/580b585b2edbce24c47b270f.png");
            height: 5vw;
            width: 5vw;
            left: 50vw;
            top: 9vh;
            /*display: block;*/
        }
    </style>
</head>
<body>
<parent-parallax>
    <child-parallax id="dust"></child-parallax>
    <child-parallax id="sun"></child-parallax>
    <child-parallax id="car"></child-parallax>
</parent-parallax>


<script>
  // import {ChildrenChangedMixin} from "https://unpkg.com/children-changed-callback@1.1.0/src/ChildrenChangedMixin.js";

  let zooming = 1;
  let topPos = 25;
  let topDustPos = 10;
  let sunLeft = 50;
  let initialTouchY = undefined;
  let movedDistY = 0;

  class ParentParallax extends HTMLElement {
    constructor() {
      super();
      this.attachShadow({mode: "open"});
      this.shadowRoot.innerHTML = `
        <style>
         :host(){
         display: block;
         position: fixed;
         }
         </style>
<slot></slot>`;


      this.addEventListener("wheel", (e) => {
        e.preventDefault();
        if (e.deltaY < 0)
          return;
        this.handleData(e.deltaY);
      }, true);


      this.addEventListener("touchmove", (e) => {
        e.preventDefault();
        if (!initialTouchY)
          initialTouchY = e.touches[0].clientY;
        movedDistY = e.touches[0].clientY - initialTouchY;
        if (movedDistY < 0) {
          initialTouchY = undefined;
          return;
        }
        this.handleData(movedDistY * 3)
      }, true);

      this.addEventListener("touchend", (e) => {
        e.preventDefault();
        initialTouchY = undefined;
      }, true);

    }


    handleData(dist) {
      topPos += 0.8;
      zooming += dist / 1000;
      Array.from(this.children).filter(item => item instanceof ChildParallax)
        .forEach((el) => {

          if (el.id === "sun") {
            el.changeLeftPosition(sunLeft);
            sunLeft += 0.1;
          }
          else if (el.id === "dust") {
            el.changeZoom(zooming * 0.8);
            el.changeTopPosition(topDustPos);
          }
          else {
            el.changeZoom(zooming);
            el.changeTopPosition(topPos);
          }
        });

    }


    changed() {
      // can be called from a child's class
    }


  }

  class ChildParallax extends HTMLElement {
    constructor() {
      super();
      this.attachShadow({mode: "open"});
      this.shadowRoot.innerHTML = `
        <style>
         :host{
         display: block;
         position: fixed;
         }
         </style>`;
    }

    //  observes its own attributes
    static get observedAttributes() {
      return ["style"];
    }


    attributeChangedCallback(name, oldValue, newValue) {
      this.setAttribute("parallax", "");
      this.parentNode.changed(name, newValue);
    }

    // provides its parent with a set of methods
    changeZoom(zoom) {
      this.style.transform = `scale(${zoom})`;
    }

    changeTopPosition(position) {
      this.style.top = position + "vh";
    }

    changeLeftPosition(position) {
      this.style.left = position + "vw";
    }

  }

  customElements.define("parent-parallax", ParentParallax);
  customElements.define("child-parallax", ChildParallax);
</script>
</body>
</html>