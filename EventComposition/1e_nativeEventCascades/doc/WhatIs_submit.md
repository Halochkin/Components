# What is `submit` ?

The submit event fires when a `<form>` is submitted. It is usually used to check (validate) the form before it is submitted to the server or to prevent it from being sent and processed using JavaScript.

There are 3 ways to submit a form:

1. Press the `<input type="submit">`, `<input type="image">` or `<button type="submit"> Submit </button>` element;
    #### Example
    
     ```html
      <form>
        <input type="text" value="I didn't say it would be easy. I just promised to tell the truth.">
      
        <input type="submit">
        <input type="image" src="https://via.placeholder.com/150" width="50">
        <button type="submit"> Submit </button>   
      </form>
   
      <script>
       window.addEventListener("submit", e => {
        e.preventDefault();
        console.log("Wait, how about a cup of tea?");
       });
      </script>
     ```
   
2. Press `Enter` key when input field has active focus.
Sending a form by pressing the `Enter` key in a text field with active focus generates a `click` event on the top submit button in the DOM.
    
    There are several features to use the `Enter` key to submit a form:
    1. If there are several submit buttons - `click` event will be generate on first button in the DOM tree order;
       #### Example
          ```html
          <form>
            <input type="text" value="Press Enter key">
            <input type="submit">  
            <button type="submit">Submit</button>
          </form>
          
          <script>
            let one = document.querySelector("input[type=submit]");
            let two = document.querySelector("button");
          
            function log(e) {
              console.log(e.type, " event on ", e.target.tagName);
            }
          
            one.addEventListener("click", e => log(e)); //generated by Enter key
            two.addEventListener("click", e => log(e)); // no click
            window.addEventListener("submit", e => log(e));
          </script>
         ```
   
    2. If there is one event `<input>` - `submit` event will fire, whether or not there is a submit button.
       #### Example
            ```html
               <form>
                   <input type="text" value="Press Enter key">
               </form>
               
               <script>
                 function log(e) {
                   console.log(e.type, " event on ", e.target.tagName);
                 }
       
                 window.addEventListener("submit", e => log(e)); //will be activated
                 window.addEventListener("click", e => log(e));  //not fires
               </script>
            ```    
    3. If there are several `<input>`s and there is no submit button - `submit` event will **not** fire.
       #### Example
       ```html
       <form>
           <input type="text" value="Press Enter key">
           <input type="text" value="Press Enter key here too">
       </form>
       
       <script>
         function log(e) {
           console.log(e.type, " event on ", e.target.tagName);
         }
       
         window.addEventListener("submit", e => log(e)); //not fire
       </script>
       ```    

3. Call `.submit()/.requestSubmit()` on `<form>` element.
   To submit form manually, it is possible to call either `.submit()` or `.requestSubmit()` methods. Both methods are similar, but there's a difference:
   
   1. `.submit()` - submits form but `submit` event is not fires. It is assumed that if the programmer calls `form.submit()`, then the script already did all related processing. This method does not provide form validation.
       
 This means that the browser does not guarantee that the data entered in the field with a certain type of data meets the requirements. For example, if the user set text value into `<input type="number">` and tries to send a form. 
 
   > Since the verification is performed only when the first two methods are used - trying to submit a form that does not pass validation triggers an invalid event. In this case, the validation prevents form submission, and thus there is no submit event.
 
 2.  `.requestSubmit()` guarantees to the browser that the entered data will be verified and in case of entering incorrect data the user will be warned about an error and the form will not be able to be sent until all data are entered correctly. Once the form is submitted, the `submit` event is fire on `<form>` element.
 
 To see the difference, consider a small example
   #### Example
    
   ```html
 <form>
     <input type="number" size="300" placeholder="try to set e character and submit form"/>
     <input type="submit">
     <div id="one"> submit()</div>
     <div id="two"> requestSubmit()</div>
 </form>
 
 <script>
   document.querySelector("#one").addEventListener("click", e => e.target.parentNode.submit());
   document.querySelector("#two").addEventListener("click", e => e.target.parentNode.requestSubmit());
 
   window.addEventListener("submit", e => {
     e.preventDefault();
     console.log("submit event has been initiated by: #", e.target.id); 
   });
 </script>
   ```

 ### Demo: SubmitController
 //todo: add description
 //todo: 
 
 ```html
<form name="one" id="one">
    <fieldset>
        <legend>Click "Submit" button or press Enter</legend>
        <input type="text" value="Tell us your story" name="story">
        <input type="text" value="Tell us your story" name="story">
        <br>
        <input id="a" type="submit">

        <div type="submit" id="b"> requestSubmit(button)</div>
        <div type="submit" id="c"> requestSubmit()</div>
    </fieldset>
</form>

<form id="two">
    <fieldset>
        <legend>Click the "Submit" button, but it will not help).</legend>
        <input type="text" value="Tell us your story" name="story">
        <input type="text" value="Tell us your story" name="story">
        <br>
        <input id="a1" type="submit">

        <div type="submit" id="b1"> requestSubmit(button)</div>
        <div type="submit" id="c1"> requestSubmit()</div>
    </fieldset>
</form>

<script>


  (function () {
    function toggleTick(cb) {
      const details = document.createElement("details");
      details.style.display = "none";
      details.ontoggle = cb;
      document.body.appendChild(details);
      details.open = true;
      Promise.resolve().then(details.remove.bind(details));
      return {
        cancel: function () {
          details.ontoggle = undefined;
        },
        resume: function () {
          details.ontoggle = cb;
        }
      };
    }

    const SubmitController = {
      state: new WeakMap(),
      submitEvent: new InputEvent("my-submit", {composed: true, bubbles: true, cancelable: true}),


      beforeinput: function (e) {
        // here we handle Enter key press submitting
        let formElement = e.target.form;

        // we can use only Enter key
        if (e.inputType !== "insertLineBreak" || !formElement)
          return;

        // check how many allowed input elements (not type=reset/submit) are located in the form
        let inputs = formElement.querySelectorAll("input:not([type=reset]):not([type=submit])").length;
        // select first submit button (default button according to spec)
        let firstSubmitButton = formElement.querySelector("input[type=submit]");

        // According to spec(https://html.spec.whatwg.org/multipage/form-control-infrastructure.html#implicit-submission)
        // 1. if 1 or several inputs and one or several submit buttons - click() on first one (default button) and then submit
        if (inputs >= 1 && firstSubmitButton)
          firstSubmitButton.click(); //click: will handle it
        //2. if only 1 input  - fire submit event on <form> (even without submit button)
        else if (inputs === 1) {
          // delay event to make it possible to prevent it
          toggleTick(() => {
            formElement.dispatchEvent(SubmitController.submitEvent);
            if (SubmitController.submitEvent.defaultPrevented) {
              clearTimeout(i);
              console.log("defaultPrevented ");
            }
          });
          //fires after toggleClick to provide default action preventation
          let i = setTimeout(() => {
            console.log("do default action here");
          }, 0);
        }
      },

      click: function (e) {
        let formElement = e.target.form;
        let val = e.target.getAttribute("type");
        if (e.target.type && e.target.type !== "submit" || val !== "submit" || !formElement)
          return;

        toggleTick(() => {
          formElement.dispatchEvent(SubmitController.submitEvent);
          if (SubmitController.submitEvent.defaultPrevented) {
            clearTimeout(i);
            console.log("defaultPrevented ");
          }
        });

        let i = setTimeout(() => {
          console.log("do default action here");
        }, 0);
      },

      requestSubmit: function (submitButton) {

        // some browsers can not support .requestSubmit()
        toggleTick(() => {
          this.dispatchEvent(SubmitController.submitEvent);
          if (SubmitController.submitEvent.defaultPrevented) {
            clearTimeout(i);
            console.log("defaultPrevented ");
          }
        });

        let i = setTimeout(() => {
          console.log("do default action here");
        }, 0);
      }
    };

    // we can fire submit event using Enter key or click on the submit button , but we have several conditions defined in spec
    window.addEventListener("beforeinput", SubmitController.beforeinput.bind(this), true);
    // window.addEventListener("focusin", SubmitController.focusin, true);
    window.addEventListener("click", SubmitController.click, true);
    //no event, because it can be called programmatically and not based on event.
    // not use arrow function here, because this keyword refers to window object
    HTMLFormElement.prototype.requestSubmit = function (submitter) {
      SubmitController.requestSubmit.call(this)
    };
  })();


  window.addEventListener("submit", e => e.preventDefault());
  // we need to block "beforeinput" event because by default it provides .click on submit button by default. We already have such custom click and we dont need 2 clicks;
  window.addEventListener("beforeinput", e => e.preventDefault());


  let one = document.querySelector("#one");
  let two = document.querySelector("#two");

  let button = document.querySelector("#a");
  let button1 = document.querySelector("#a1");

  //form 1, must log "do default action here"
  document.querySelector("#b").addEventListener("click", () => one.requestSubmit(button));
  document.querySelector("#c").addEventListener("click", () => one.requestSubmit());

  //form 2 preventable, must log "defaultPrevented"
  document.querySelector("#b1").addEventListener("click", () => two.requestSubmit(button1));
  document.querySelector("#c1").addEventListener("click", () => two.requestSubmit());

  one.addEventListener("my-submit", e => console.warn(e.type));
  two.addEventListener("my-submit", e => console.warn(e.type));
  two.addEventListener("my-submit", e => e.preventDefault());


  window.addEventListener("click", e=> console.log(e.type, " on ", e.target.id))

</script>
```

#### References

1. [MDN: `submit` event](https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/submit_event);
2. [MDN: `.submit()`](https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/submit);
3. [MDN: `.requestSubmit()`](https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/requestSubmit);








